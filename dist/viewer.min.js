/**
 * @file Script to add a GLB object viewer to Empretienda
 * @author Keyvin Duque <thkeyduq@gmail.com>
 * @license MIT
 * @copyright Keyvin Duque 2022
 */
import*as THREE from"three";import{GLTFLoader}from"three/addons/loaders/GLTFLoader.js";import{OrbitControls}from"three/addons/controls/OrbitControls.js";import{RoomEnvironment}from"three/addons/environments/RoomEnvironment.js";const elements=document.getElementsByClassName("product-vip__description");let data,count=0;for(const e of elements){const n=`souzo_viewer_${count}`,t=e.textContent.indexOf("{__endpreview__}")>0?e.textContent.substring(e.textContent.indexOf("{__preview__}")+13,e.textContent.indexOf("{__endpreview__}")).trim():void 0;console.log(t),data=t?JSON.parse(t):void 0;const o=/<p>{__preview__}<\/p>(.|\s)*{__endpreview__}<\/p>/g;e.innerHTML=!1===data?.active?e.innerHTML.replace(o,""):data?e.innerHTML.replace(o,`\n        <button \n          class="button button--full background--primary background--primary-hover contrast_text--primary contrast_text--primary-hover uk-button uk-button-input border-radius" \n          id="${n}_btn_open" type="button" onclick="showViewer('${n}')">\n          Ver modelo 3D\n        </button>\n        <div id="${n}_loading"></div>\n        <div id="${n}"></div>\n        `):e.innerHTML.replace("{__preview__}",`\n        <button \n          class="button button--full background--primary background--primary-hover contrast_text--primary contrast_text--primary-hover uk-button uk-button-input border-radius" \n          id="${n}_btn_open" type="button" onclick="showViewer('${n}')">\n          Ver modelo 3D\n        </button>\n        <div id="${n}_loading"></div>\n        <div id="${n}"></div>\n        `),count++}function render(e,n,t){e.render(n,t)}function onResize(e,n,t,o,r){t.aspect=o/r,t.updateProjectionMatrix(),e.setSize(o,r),render(e,n,t)}function getSlug(){const e=window.location.pathname;return e.substring(e.lastIndexOf("/")+1)}function fitCameraToCenteredObject(e,n,t){const o=new THREE.Box3;o.setFromObject(n);const r=o.getCenter(new THREE.Vector3),i=o.getSize(new THREE.Vector3),d=Math.max(i.x,i.y,i.z);console.log(d);let a=new THREE.Vector3(d,d,d);e.zoom=.5,e.left=-2*d,e.bottom=-2*d,e.top=2*d,e.right=2*d,e.near=.01,e.far=1e3*d,e.position.set(a.x,a.y,a.z),e.lookAt(0,0,0),e.updateProjectionMatrix(),t.target.set(r.x,r.y,r.z),t.update()}window.showViewer=function(e){const n=document.getElementById(e),t=document.getElementById(`${e}_loading`),o=document.getElementById(`${e}_btn_open`),r=n.clientWidth,i=Math.min(n.clientWidth,window.innerHeight),d=new THREE.WebGLRenderer({antialias:!0});d.setPixelRatio(window.devicePixelRatio),d.setSize(r,i),d.outputEncoding=THREE.sRGBEncoding,d.shadowMap.enabled=!0,d.shadowMap.type=THREE.PCFSoftShadowMap,n.appendChild(d.domElement);const a=new THREE.PMREMGenerator(d),s=new THREE.Scene;s.background=new THREE.Color(16777215),s.environment=a.fromScene(new RoomEnvironment).texture;const c=new THREE.DirectionalLight(16777215,1);c.position.set(1,1,1),c.castShadow=!0,c.shadow.camera.far=1e3,s.add(c);const l=new THREE.PerspectiveCamera(30,r/i,1,1e3);(new GLTFLoader).setPath("https://cdn.jsdelivr.net/gh/keyduq/souzo-viewer@master/samples/").load(data?.filename??`${getSlug()}_preview.glb`,(function(e){const n=e.scene;n.traverse((function(e){if(e.isMesh){e.castShadow=!0;const n=new OrbitControls(l,d.domElement);fitCameraToCenteredObject(l,e,n),n.addEventListener("change",(()=>{onResize(d,s,l,r,i)}))}})),s.add(n),render(d,s,l),o.style.display="none",t.innerHTML=""}),(function(e){o.style.display="none",t.innerHTML="Loading...",console.log(e.loaded+" loaded.")}),(function(e){o.style.display="display",console.error(e)}))},window.closeViewer=function(e){const n=document.etElementById(e),t=document.getElementById(`${e}_btn_open`),o=document.getElementById(`${e}_btn_close`);n.innerHTML="",t.style.display="block",o.style.display="none"};