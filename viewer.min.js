/**
 * @preserve
 * @file Script to add a GLB object viewer to Empretienda
 * @author Keyvin Duque <thkeyduq@gmail.com>
 * @license MIT
 * @copyright Keyvin Duque 2022
 * @endpreserve
 */
import*as THREE from"three";import{GLTFLoader}from"three/addons/loaders/GLTFLoader.js";import{OrbitControls}from"three/addons/controls/OrbitControls.js";import{RoomEnvironment}from"three/addons/environments/RoomEnvironment.js";const elements=document.getElementsByClassName("product-vip__description");let data,count=0;for(const e of elements){const t=`souzo_viewer_${count}`,n=e.textContent.substring(e.textContent.indexOf("{__preview__}")+13,e.textContent.indexOf("{__endpreview__}")-1);data=JSON.parse(n);const o=/<p>{__preview__}<\/p>(.|\s)*{__endpreview__}<\/p>/g;!1===data.active?e.innerHTML=e.innerHTML.replace(o,""):e.innerHTML=e.innerHTML.replace(o,`\n      <button \n        class="button button--full background--primary background--primary-hover contrast_text--primary contrast_text--primary-hover uk-button uk-button-input border-radius" \n        id="${t}_btn_open" type="button" onclick="showViewer('${t}')">\n        Ver modelo 3D\n      </button>\n      <div id="${t}_loading"></div>\n      <div id="${t}"></div>\n      `),count++}function render(e,t,n){e.render(t,n)}function onResize(e,t,n,o,i){n.aspect=o/i,n.updateProjectionMatrix(),e.setSize(o,i),render(e,t,n)}function getSlug(){const e=window.location.pathname;return e.substring(e.lastIndexOf("/")+1)}function fitCameraToCenteredObject(e,t,n){const o=new THREE.Box3;o.setFromObject(t);const i=o.getCenter(new THREE.Vector3),r=o.getSize(new THREE.Vector3),a=Math.max(r.x,r.y,r.z);let d=new THREE.Vector3(a,a,a);e.zoom=.5,e.left=-2*a,e.bottom=-2*a,e.top=2*a,e.right=2*a,e.near=.01,e.far=1e3*a,e.position.set(d.x,d.y,d.z),e.lookAt(0,0,0),e.updateProjectionMatrix(),n.target.set(i.x,i.y,i.z),n.update()}window.showViewer=function(e){const t=document.getElementById(e),n=document.getElementById(`${e}_loading`),o=document.getElementById(`${e}_btn_open`),i=t.clientWidth,r=Math.min(t.clientWidth,window.innerHeight),a=new THREE.WebGLRenderer({antialias:!0});a.setPixelRatio(window.devicePixelRatio),a.setSize(i,r),a.outputEncoding=THREE.sRGBEncoding,a.shadowMap.enabled=!0,a.shadowMap.type=THREE.PCFSoftShadowMap,t.appendChild(a.domElement);const d=new THREE.PMREMGenerator(a),s=new THREE.Scene;s.background=new THREE.Color(16777215),s.environment=d.fromScene(new RoomEnvironment).texture;const c=new THREE.DirectionalLight(16777215,1);c.position.set(1,1,1),c.castShadow=!0,c.shadow.camera.far=1e3,s.add(c);const l=new THREE.PerspectiveCamera(30,i/r,1,1e3);(new GLTFLoader).setPath("https://cdn.jsdelivr.net/gh/keyduq/souzo-viewer@master/samples/").load(data.filename??getSlug(),(function(e){const t=e.scene;t.traverse((function(e){if(e.isMesh){e.castShadow=!0;const t=new OrbitControls(l,a.domElement);fitCameraToCenteredObject(l,e,t),t.addEventListener("change",(()=>{onResize(a,s,l,i,r)}))}})),s.add(t),render(a,s,l),o.style.display="none",n.innerHTML=""}),(function(e){o.style.display="none",n.innerHTML="Loading..."}),(function(e){o.style.display="display"}))},window.closeViewer=function(e){const t=document.etElementById(e),n=document.getElementById(`${e}_btn_open`),o=document.getElementById(`${e}_btn_close`);t.innerHTML="",n.style.display="block",o.style.display="none"};